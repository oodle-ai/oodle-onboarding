sources:
  docker_logs:
    type: docker_logs
    docker_host: unix:///var/run/docker.sock
    include_containers:
      - demo-app

transforms:
  parse_json:
    type: remap
    inputs:
      - docker_logs
    source: |
      . = parse_json!(.message)

  add_timestamp:
    type: remap
    inputs:
      - parse_json
    source: |
      # Add @timestamp field for OpenSearch Dashboards
      .@timestamp = .timestamp

sinks:
  # OpenSearch local
  opensearch:
    type: elasticsearch
    inputs:
      - add_timestamp
    endpoints:
      - http://opensearch:9200
    mode: bulk
    bulk:
      index: logs-%Y.%m.%d
    compression: none
    healthcheck:
      enabled: true
    suppress_type_name: true

  # Oodle cloud
  oodle:
    type: http
    inputs:
      - add_timestamp
    uri: "https://${OODLE_INSTANCE}-logs.collector.oodle.ai/ingest/v1/logs"
    encoding:
      codec: json
    compression: gzip
    request:
      headers:
        X-OODLE-INSTANCE: "${OODLE_INSTANCE}"
        X-API-KEY: "${OODLE_API_KEY}"
      retry_attempts: 3
      timeout_secs: 60
